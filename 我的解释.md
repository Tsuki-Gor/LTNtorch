# 一

### LTN 作为 PyTorch 计算图

实际上，LTN 将 Real Logic 公式（例如：$$\forall x \exists y (\text{friend}(x,y) \land \text{italian}(y))$$，表示每个人都有一个意大利朋友）转换为 PyTorch 计算图。此类公式可以表达有关数据的复杂查询、学习过程中要满足的先验知识、需要证明的陈述等。下图展示了 LTN 如何将此类公式转换为 PyTorch 计算图。

例如，如果 \( R \) 表示朋友的谓词，\( A \) 表示意大利人的谓词，则以下计算图将英语句子“每个人都有一个意大利朋友”转换为计算图。

假设我们有 6 个人，用 4 个实值特征表示。上图说明了以下内容：

1. 变量 \( x \) 和 \( y \) 是我们 6 个人的两个序列，记作 \( G(x) = G(y) = \mathbb{R}^{6 \times 4} \)。在图中，人的特征在深度维度中表示；
2. \( R \) 是一个二元谓词，它接收两个变量 \( x \) 和 \( y \) 作为输入，并返回一个矩阵 \( M \in [0,1]^{6 \times 6} \)，这是对所有人对的谓词 \( R \) 的评估结果。在图中，矩阵的第一个维度与变量 \( x \) 关联，而第二个维度与变量 \( y \) 关联。例如，位置 [0, 2] 的真值是对第一个人和第三个人的谓词 \( R \) 的评估结果；
3. \( A \) 是一个一元谓词，它接收一个变量 \( y \) 作为输入，并返回一个向量 \( v \in [0,1]^{6} \)，这是对变量 \( y \) 上每个人的谓词 \( A \) 的评估结果。在图中，只有一个与变量 \( y \) 关联的维度；
4. \( \land \) 是一个二元模糊算子，推广了逻辑合取。该算子按元素应用于矩阵 \( M \) 和向量 \( v \)，并返回一个新矩阵 \( N \in [0,1]^{6 \times 6} \)，这是 \( M \) 和 \( v \) 的模糊逻辑合取。如果操作数（输入）形状不同，则会应用广播。在图中，如果您有兴趣，PyTorch 实现的常见模糊算子可在 ltn.fuzzy_ops 中找到；
5. \( \exists y \) 是一个模糊聚合器，推广了存在量化。该聚合器接受输入矩阵 \( N \) 并沿与变量 \( y \) 关联的维度进行聚合，结果为一个向量 \( u \in [0,1]^{6} \)，包含聚合结果；
6. \( \forall x \) 是一个模糊聚合器，推广了普遍量化。该聚合器接受输入向量 \( u \) 并沿与变量 \( x \) 关联的维度进行聚合，结果为一个标量 \( c \in [0,1] \)，包含聚合结果。此结果也是初始公式 $$\forall x \exists y (\text{friend}(x,y) \land \text{italian}(y))$$ 的最终结果，可以解释为公式的满意度水平。

### 举例解释

假设我们有 6 个人，每个人用 4 个特征表示，比如 [年龄，收入，教育水平，健康指数]。如下：

$$
x = \begin{pmatrix}25 & 4000 & 5 & 80 \\ 30 & 5000 & 6 & 90 \\ 28 & 4500 & 5 & 85 \\ 35 & 5500 & 7 & 95 \\ 22 & 3800 & 4 & 75 \\ 33 & 5200 & 6 & 88\end{pmatrix}
$$

$$
y = \begin{pmatrix}25 & 4000 & 5 & 80 \\ 30 & 5000 & 6 & 90 \\ 28 & 4500 & 5 & 85 \\ 35 & 5500 & 7 & 95 \\ 22 & 3800 & 4 & 75 \\ 33 & 5200 & 6 & 88\end{pmatrix}
$$

### 谓词评估

- 朋友谓词 \( R(x,y) \) 的评估结果可能是一个 6x6 的矩阵 \( M \)，其中每个元素表示两个个体是否是朋友，例如：
$$
M = \begin{pmatrix}1 & 0.5 & 0.8 & 0 & 0.6 & 0.4 \\ 0.5 & 1 & 0.6 & 0.3 & 0.2 & 0.7 \\ 0.8 & 0.6 & 1 & 0.4 & 0.3 & 0.5 \\ 0 & 0.3 & 0.4 & 1 & 0.7 & 0.2 \\ 0.6 & 0.2 & 0.3 & 0.7 & 1 & 0.9 \\ 0.4 & 0.7 & 0.5 & 0.2 & 0.9 & 1\end{pmatrix}
$$

- 意大利人谓词 \( A(y) \) 的评估结果可能是一个 6x1 的向量 \( v \)，其中每个元素表示个体是否是意大利人，例如：
$$
v = \begin{pmatrix}0.8 \\ 0.4 \\ 0.5 \\ 0.7 \\ 0.6 \\ 0.9\end{pmatrix}
$$

### 逻辑运算与聚合

- \( \land \) 运算将 \( M \) 和 \( v \) 逐元素结合，结果是：
$$
N = \begin{pmatrix}0.8 & 0.4 & 0.5 & 0 & 0.6 & 0.4 \\ 0.4 & 0.4 & 0.4 & 0.3 & 0.2 & 0.7 \\ 0.5 & 0.4 & 0.5 & 0.4 & 0.3 & 0.5 \\ 0 & 0.3 & 0.4 & 0.7 & 0.6 & 0.2 \\ 0.6 & 0.2 & 0.3 & 0.6 & 0.6 & 0.9 \\ 0.4 & 0.4 & 0.5 & 0.2 & 0.6 & 0.9\end{pmatrix}
$$

- \( \exists y \) 聚合操作沿着 \( y \) 的维度聚合 \( N \)，结果是向量 \( u \)：
$$
u = \begin{pmatrix}0.8 \\ 0.7 \\ 0.7 \\ 0.7 \\ 0.9 \\ 0.9\end{pmatrix}
$$

- \( \forall x \) 聚合操作沿着 \( x \) 的维度聚合 \( u \)，结果是标量 \( c \)，例如：
$$
c = 0.75
$$

这个结果表示公式 \( \forall x \exists y (\text{friend}(x,y) \land \text{italian}(y)) \) 的满意度水平为 0.75。